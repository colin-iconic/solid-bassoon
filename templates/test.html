{% extends "layout.html" %}
{% block body %}
<script src="http://d3js.org/d3.v3.min.js"></script>
<div id="tot">
</div>

<script>
	data = [{% for customer in quotes['customers'] %}{"label":"{{ customer }}", "value": {{ quotes['customer_total'][customer] }}},{% endfor %}{"label":" ", "value": 0}];

	var threshold = {{ quotes['total_value'] }}/20

	big_items = data.filter(item => item.value > threshold);
	small_items = data.filter(item => item.value <= threshold);
	collected_value = {
	    label: `Other - ${small_items.length} items`,
	    value: small_items.reduce((accumulator, item) => accumulator + item.value, 0)
	}
	big_items.push(collected_value);

	data = big_items

  var w = 400;
  var h = 300;
  var r = (h-100)/2;
  var aColor = ['rgb(12,192,170)', 'rgb(37,115,139)', 'rgb(135,206,254)', 'rgb(129,132,251)', 'rgb(202,45,197)', 'rgb(233,201,250)', 'rgb(208,113,172)', 'rgb(133,111,145)']


  var vis = d3.select('#tot').append("svg:svg").data([data]).attr("width", w).attr("height", h).append("svg:g").attr("transform", "translate(" + w/2 + "," + (r+50) + ")");

  var pie = d3.layout.pie().value(function(d){return d.value;});

  // Declare an arc generator function
  var arc = d3.svg.arc().outerRadius(r);

  // Select paths, use arc generator to draw
  var arcs = vis.selectAll("g.slice").data(pie).enter().append("svg:g").attr("class", "slice");
  arcs.append("svg:path")
      .attr("fill", function(d, i){return aColor[i];})
      .attr("d", function (d) {return arc(d);})
  ;

	arcs.append("text")
	    .attr("text-anchor", "middle")
	    .attr("x", function(d) {
	        var a = d.startAngle + (d.endAngle - d.startAngle)/2 - Math.PI/2;
	        d.cx = Math.cos(a) * (r - 45);
	        return d.x = Math.cos(a) * (r+30);
	    })
	    .attr("y", function(d) {
	        var a = d.startAngle + (d.endAngle - d.startAngle)/2 - Math.PI/2;
	        d.cy = Math.sin(a) * (r - 45);
	        return d.y = Math.sin(a) * (r + 30);
	    })
	    .text(function(d) { return d.data.label;})
	    .each(function(d) {
	        var bbox = this.getBBox();
	        d.sx = d.x - bbox.width/2 - 2;
	        d.ox = d.x + bbox.width/2 + 2;
	        d.sy = d.oy = d.y + 5;
	    });

		arcs.append("path")
	    .attr("class", "pointer")
	    .style("fill", "none")
	    .style("stroke", "black")

	    .attr("d", function(d) {
	     console.log(d);
	        if(d.cx > d.ox) {
	            return "M" + d.sx + "," + d.sy + "L" + d.ox + "," + d.oy + " " + d.cx + "," + d.cy;
	        } else {
	            return "M" + d.ox + "," + d.oy + "L" + d.sx + "," + d.sy + " " + d.cx + "," + d.cy;
	        }
	    });
</script>
{% endblock %}
