{% extends "layout.html" %}
{% block body %}
<script src="http://d3js.org/d3.v3.min.js"></script>
<style type="text/css">
  .progress-bars {
   width: 950px;
   min-height: 100px;
   margin-bottom: 50px;
   padding: 25px 0 0 25px;
   float: left;
  }

  //The actual bar with the progress
  .bar {
     display: block;
     overflow: hidden;
     height: 18px;
     width: 0px;
     border: 1px solid rgba(0, 0, 0, 0.5);
     border-radius: 10px;
     margin-bottom: 5px;
     margin-left: 10px;
     box-shadow: 1px 1px 1px #888888;
  }

  //The pattern
  .pattern {
     height: 100%;
     width: 100%;
     background-image: url(../images/pattern.png);
     background-color: #FB7457;
  }

  //Div to display the percentage
  .percentage {
     margin-left: 0px;
     text-align: center;
     font-family: "Verdana", sans-serif;
     font-size: 0.8em;
     line-height: 18px;
  }
</style>
<h2 class="no-print">Job Progress</h2>
<form method="GET" class="no-print" style="font-size: 1.5em">
	Search: <input name="job" placeholder="{{ job_details['job'] }}">
	<button type="submit">Submit</button>
</form>
<br />
<div style="padding: 10px; background: white;">
  <h3>{{ job_details['job'] }}</h3>
  <div id="progress-bar">
  </div>
  <table style="width: 500px; font-size: 1.5em">
    <tr>
      <td>Customer: </td>
      <td><a href="/customer_jobs?customer={{ job_details['customer'] }}">{{ job_details['customer'] }}</a></td>
    <tr>
      <td>Status: </td>
      <td>{{ job_details['status'] }}</td>
    </tr>
    <tr>
      <td>Part: </td>
      <td><a href="/part_viewer?part={{ job_details['part number'] }}">{{ job_details['part number'] }}</a></td>
    </tr>
    <tr>
      <td>Quantity: </td>
      <td>{{ job_details['quantity'] }}</td>
    </tr>
    <tr>
      <td>Customer PO: </td>
      <td><a href="/po_viewer?po={{ job_details['customer po'] }}">{{ job_details['customer po'] }}</a></td>
    </tr>
    <tr>
      <td>Order Date: </td>
      <td>{{ job_details['order date'] }}</td>
    </tr>
    <tr>
      <td>Promised Date: </td>
      <td>{{ job_details['promised date'] }}</td>
    </tr>
    <tr>
      <td>Current Work Center: </td>
      <td>{{ job_details['current wc'] }}</td>
    </tr>
  </table>
  <br />
  Job Notes:<br />
  <p style="width: 500px; font-size: 1.5em">{{ job_details['note text'] }}</p>
  <br />
  Ship To:<br />
  <p style="width: 500px; font-size: 1.5em">{% for line in job_details['address'] %}
    {{ line }}<br />
  {% endfor %}</p>
</div>
<script>
  //Data
  var data = {{ progress }};
  var colors = { green: '#4DC87F', lightGreen: '#D9F0E3' };
  var width = 960, height = 480, offset = 48;

   width += offset * 2;
   height += offset * 2;
   var dimensions = '' + 0 + ' ' + 0 + ' ' + width + ' ' + height;

   var svg = d3.select('#progress-bar').append('svg')
       .attr('id', 'scene', true)
       .attr('preserveAspectRatio', 'xMinYMin meet')
       .attr('viewBox', dimensions)
       .classed('svg-content', true);

   var steps = ['0', '1', '2', '3', '4', '5'];
   stepWidth = (width - offset * 2) / (steps.length - 1),
   currentStep = "0";

   var progressBar = svg.append('g')
                 .attr('transform', 'translate(' + offset + ',' + offset + ')')
                 .style('pointer-events', 'none');

   var progressBackground = progressBar.append('rect')
       .attr('fill', colors.lightGreen)
       .attr('height', 8)
       .attr('width', width - offset * 2)
       .attr('rx', 4)
       .attr('ry', 4);

   var progress = progressBar.append('rect')
       .attr('fill', colors.green)
       .attr('height', 8)
       .attr('width', 0)
       .attr('rx', 4)
       .attr('ry', 4);

   progress.transition()
       .duration(1000)
       .attr('width', function(){
           var index = steps.indexOf(currentStep);
           return (index + 1) * stepWidth;
       });

   progressBar.selectAll('circle')
   .data(steps)
   .enter()
   .append('circle')
   .attr('id', function(d, i){ return 'step_' + i; })
   .attr('cx', function(d, i){ return i * stepWidth; })
   .attr('cy', 4)
   .attr('r', 20)
   .attr('fill', '#FFFFFF')
   .attr('stroke', colors.lightGreen)
   .attr('stroke-width', 6)

   progressBar.selectAll('text')
   .data(steps)
   .enter()
   .append('text')
   .attr('id', function(d, i){ return 'label_' + i; })
   .attr('dx', function(d, i){ return i * stepWidth; })
   .attr('dy', 10)
   .attr('text-anchor', 'middle')
   .text(function(d, i) { return i + 1; })

   updateProgressBar(data.toString(););

   //self-running demo
   //setInterval(function() { updateProgressBar(Math.floor(Math.random() * (steps.length - 1)).toString()); } , 2500)

   function setupProgressBar(data_){

   var output = [];
   for(var i = 0; i < data_.length; i++){ output.push(data_[i].id.toString()); }
   return output;

   }

   function updateProgressBar(step_){

       progress.transition()
           .duration(1000)
           .attr('fill', colors.green)
           .attr('width', function(){
               var index = steps.indexOf(step_);
               return (index) * stepWidth;
           });

       for(var i = 0; i < steps.length; i++){

           if(i <= steps.indexOf(step_)) {

               d3.select('#step_' + i).attr('fill', colors.green).attr('stroke', colors.green);
               d3.select('#label_' + i).attr('fill', '#FFFFFF');


           } else {

               d3.select('#step_' + i).attr('fill', '#FFFFFF').attr('stroke', colors.lightGreen);
               d3.select('#label_' + i).attr('fill', '#000000');

           }

       }

   }
</script>
{% endblock %}
